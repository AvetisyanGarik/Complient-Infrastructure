    - name: Ensure output directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Read golden config file
      ansible.builtin.slurp:
        src: "{{ golden_base_dir }}/{{ inventory_hostname }}.txt"
      register: golden_config_content
      delegate_to: localhost
      ignore_errors: false

    - name: Decode golden config
      ansible.builtin.set_fact:
        golden_config_lines: "{{ golden_config_content.content | b64decode | splitlines }}"

    - name: Get running/startup config from IOS
      cisco.ios.ios_command:
        commands: [ "show startup-config" ]
      register: startup_config_ios
      when: ansible_network_os == 'cisco.ios.ios'

    - name: Get running config from ASA
      cisco.asa.asa_command:
        commands: [ "show running-config" ]
      register: startup_config_asa
      when: ansible_network_os == 'cisco.asa.asa'

    - name: Extract config lines from device
      ansible.builtin.set_fact:
        startup_config_lines: >-
          {{
            (startup_config_ios.stdout[0] if startup_config_ios is defined and startup_config_ios.stdout is defined
            else startup_config_asa.stdout[0]) | splitlines
          }}

    - name: Generate HTML diff with difflib
      ansible.builtin.set_fact:
        config_diff_html: >-
          {{
            lookup('template', 'html_diff_template.j2')
          }}

    - name: Save diff HTML file
      ansible.builtin.copy:
        content: "{{ config_diff_html }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}_config_diff_{{ date_tag }}.html"
      delegate_to: localhost

    - name: Gather all HTML diffs
      ansible.builtin.set_fact:
        all_html_diffs: "{{ groups['all'] | map('extract', hostvars, 'config_diff_html') | list }}"
      run_once: true

    - name: Compose final email body
      ansible.builtin.set_fact:
        email_body_html: |
          <html>
          <body>
          <h2>ðŸ›  Configuration Diff Report</h2>
          <p>Date: {{ date_tag }}</p>
          {% for host in groups['all'] %}
            <h3>{{ host }}</h3>
            {{ hostvars[host]['config_diff_html'] | safe }}
            <hr>
          {% endfor %}
          </body>
          </html>
      run_once: true

    - name: Send email with HTML diff
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username }}"
        password: "{{ smtp_password }}"
        to: "{{ email_to }}"
        subject: "ðŸ›  Config Diff Report â€“ {{ date_tag }}"
        body: "{{ email_body_html }}"
        subtype: html
        secure: always
        sender: "root@example.com"
      run_once: true
      delegate_to: localhost
