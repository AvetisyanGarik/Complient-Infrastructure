  - name: Ensure output directory exists
    ansible.builtin.file:
      path: "{{ output_dir }}"
      state: directory
      mode: '0755'
    delegate_to: localhost

  - name: Attempt to read golden config file (ignore errors)
    ansible.builtin.slurp:
      src: "{{ golden_base_dir }}/{{ inventory_hostname }}.txt"
    register: golden_config_raw
    ignore_errors: true
    delegate_to: localhost

  - name: Normalize golden config lines
    ansible.builtin.set_fact:
      golden_config_lines: >-
        {{
          (golden_config_raw.content | b64decode)
          | replace('\r\n', '\n') | replace('\r', '\n')
          | split('\n') | map('trim') | select('match', '.+') | list
        }}
    when: golden_config_raw is defined and golden_config_raw.content is defined

  - name: Get startup config (Cisco IOS)
    cisco.ios.ios_command:
      commands: [show startup-config]
    register: startup_config_ios
    when: ansible_network_os == 'cisco.ios.ios'

  - name: Get running config (Cisco ASA)
    cisco.asa.asa_command:
      commands: [show running-config]
    register: startup_config_asa
    when: ansible_network_os == 'cisco.asa.asa'

  - name: Normalize startup config lines
    ansible.builtin.set_fact:
      startup_config_lines: >-
        {{
          (
            startup_config_ios.stdout[0]
            if startup_config_ios is defined and startup_config_ios.stdout is defined
            else startup_config_asa.stdout[0]
          )
          | replace('\r\n', '\n') | replace('\r', '\n')
          | split('\n') | map('trim') | select('match', '.+') | list
        }}

  - name: Compute config diff
    ansible.builtin.set_fact:
      removed_lines: "{{ golden_config_lines | difference(startup_config_lines) }}"
      added_lines: "{{ startup_config_lines | difference(golden_config_lines) }}"
    when: golden_config_lines is defined

  - name: Check if config has differences
    ansible.builtin.set_fact:
      has_diff: "{{ removed_lines | length > 0 or added_lines | length > 0 }}"

  - name: Generate formatted config diff
    ansible.builtin.set_fact:
      config_diff_text: |
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ðŸ–¥ï¸ Host: {{ inventory_hostname }}
        ðŸ“„ Golden Config: {{ golden_base_dir }}/{{ inventory_hostname }}.txt
        ðŸ“… Timestamp: {{ date_tag }}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        ðŸ”» Missing (in Golden but not in Live):
        {% if removed_lines %}
        {% for line in removed_lines %}
          - {{ line }}
        {% endfor %}
        {% else %}
          âœ… None
        {% endif %}

        ðŸ”º Added (in Live but not in Golden):
        {% if added_lines %}
        {% for line in added_lines %}
          + {{ line }}
        {% endfor %}
        {% else %}
          âœ… None
        {% endif %}

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        âœ… End of diff for {{ inventory_hostname }}
    when: has_diff | default(false)

  - name: Save config diff to file
    ansible.builtin.copy:
      dest: "{{ output_dir }}/{{ inventory_hostname }}_diff_{{ date_tag }}.txt"
      content: "{{ config_diff_text }}"
    when: has_diff | default(false)
    delegate_to: localhost

  ### EMAIL SECTION

  - name: Collect all diffs for email
    ansible.builtin.set_fact:
      all_diffs: "{{ groups['all'] | map('extract', hostvars, 'config_diff_text') | select('defined') | list }}"
    run_once: true

  - name: Combine all diffs into email body
    ansible.builtin.set_fact:
      email_body: |
        ðŸ”§ CONFIG DIFF REPORT â€“ {{ date_tag }}
        ===================================================
        {% for diff in all_diffs %}
        {{ diff }}

        ---------------------------------------------------
        {% endfor %}
        ðŸ“¢ END OF REPORT
    when: all_diffs | length > 0
    run_once: true

  - name: Send email with diffs
    ansible.builtin.mail:
      host: "{{ smtp_host }}"
      port: "{{ smtp_port }}"
      username: "{{ smtp_username }}"
      password: "{{ smtp_password }}"
      to: "{{ email_to }}"
      subject: "ðŸ›  Config Diff Report â€“ {{ date_tag }}"
      body: "{{ email_body }}"
      secure: always
      sender: root
      timeout: 20
      charset: utf-8
    when: email_body is defined
    run_once: true
    delegate_to: localhost