---
- name: Compare device configs against golden configs
  hosts: all
  gather_facts: no
  vars:
    date_tag: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"
    golden_config_path: "{{ golden_base_dir }}/{{ inventory_hostname }}_golden.txt"

  tasks:

    - name: Ensure output directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Read golden config file content
      ansible.builtin.slurp:
        src: "{{ golden_config_path }}"
      register: golden_config_content
      delegate_to: localhost

    - name: Decode golden config lines
      ansible.builtin.set_fact:
        golden_config_lines: "{{ (golden_config_content.content | b64decode).split('\n') | map('trim') | list }}"

    - name: Get startup config (live, without backup)
      cisco.ios.ios_command:
        commands:
          - show running-config
      register: startup_config
      when: ansible_network_os == 'cisco.ios.ios'

    - name: Decode startup config lines
      ansible.builtin.set_fact:
        startup_config_lines: "{{ startup_config.stdout[0].split('\n') | map('trim') | list }}"
      when: startup_config is defined and startup_config.stdout is defined

    - name: Determine if there are differences
      ansible.builtin.set_fact:
        config_diff: "{{ (startup_config_lines | default([])) | difference(golden_config_lines | default([])) }}"
        has_diff: "{{ ((startup_config_lines | default([])) | difference(golden_config_lines | default([]))).length > 0 }}"

    - name: Show differences
      ansible.builtin.debug:
        msg: |
          Differences found for {{ inventory_hostname }}:
          {{ config_diff }}
      when: has_diff

    - name: Generate visually formatted config diff
      ansible.builtin.set_fact:
        config_diff_text: |
          ─────────────────────────────────────────────────────────────
          🖥️ Host: {{ inventory_hostname }}
          📄 Golden Config: {{ golden_config_path }}
          📅 Timestamp: {{ date_tag }}
          ─────────────────────────────────────────────────────────────

          🔻 Missing (in Golden but not in Live):
          {% set removed = golden_config_lines | difference(startup_config_lines) %}
          {% if removed %}
          {% for line in removed %}
            - [Line {{ golden_config_lines.index(line) + 1 }}] {{ line }}
          {% endfor %}
          {% else %}
            ✅ None
          {% endif %}

          ─────────────────────────────────────────────────────────────

          🔺 Added (in Live but not in Golden):
          {% set added = startup_config_lines | difference(golden_config_lines) %}
          {% if added %}
          {% for line in added %}
            + [Line {{ startup_config_lines.index(line) + 1 }}] {{ line }}
          {% endfor %}
          {% else %}
            ✅ None
          {% endif %}

          ─────────────────────────────────────────────────────────────
          ✅ End of diff for {{ inventory_hostname }}
      when: has_diff

    - name: Save config diff to file
      ansible.builtin.copy:
        dest: "{{ output_dir }}/{{ inventory_hostname }}_config_diff_{{ date_tag }}.txt"
        content: "{{ config_diff_text }}"
      when: has_diff
      delegate_to: localhost

    - name: Collect all diffs for email
      ansible.builtin.set_fact:
        all_diffs: "{{ groups['all'] | map('extract', hostvars, 'config_diff_text') | select('defined') | list }}"
      run_once: true

    - name: Combine all diffs into report
      ansible.builtin.set_fact:
        email_body: |
          🔧 CONFIGURATION DIFF REPORT — SUMMARY
          ===================================================
          🕒 Date: {{ date_tag }}
          📬 Recipients: {{ email_to }}
          ===================================================

          {% for diff in all_diffs %}
          {{ diff }}
          {% endfor %}

          ===================================================
          📢 END OF REPORT
      run_once: true

    - name: Send email with config diffs
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username }}"
        password: "{{ smtp_password }}"
        to: "{{ email_to }}"
        subject: "🛠 Config Diff Report – {{ date_tag }}"
        body: "{{ email_body }}"
        secure: always
        sender: root
        timeout: 20
        charset: utf-8
      run_once: true
      delegate_to: localhost
